name: Deploy to GitHub Pages

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

env:
  # ====== BOT-HOOK CHAT (thay Mattermost) ======
  BOT_HOOK_URL: ${{ secrets.BOT_HOOK_URL || 'https://bot-hook.goldone.vn/api/send' }}
  BOT_HOOK_TOKEN: ${{ secrets.BOT_HOOK_TOKEN || 'abc123token' }}
  BOT_SENDER: ${{ secrets.BOT_SENDER || 'admin' }}
  BOT_TARGET: ${{ secrets.BOT_TARGET || '4c0c31fbffda42f7a4e0343e3342248d' }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      author_name: ${{ steps.meta_build.outputs.author_name }}
      author_email: ${{ steps.meta_build.outputs.author_email }}
      commit_msg: ${{ steps.meta_build.outputs.commit_msg }}
      triggered_by: ${{ steps.meta_build.outputs.triggered_by }}
      branch: ${{ steps.meta_build.outputs.branch }}
      repo: ${{ steps.meta_build.outputs.repo }}
      sha_short: ${{ steps.meta_build.outputs.sha_short }}
      commit_url: ${{ steps.meta_build.outputs.commit_url }}
      run_url: ${{ steps.meta_build.outputs.run_url }}

    steps:
      - uses: actions/checkout@v4

      - name: Install jq (for JSON payload)
        run: sudo apt-get update && sudo apt-get install -y jq

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - run: npm ci

      - run: npm run build
        env:
          GEMINI_API_KEY: ${{ secrets.API_KEY }}
          API_KEY: ${{ secrets.API_KEY }}

      - run: cp dist/index.html dist/404.html

      - uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      - name: Collect build metadata
        id: meta_build
        shell: bash
        run: |
          AUTHOR_NAME="${{ github.event.head_commit.author.name || '' }}"
          AUTHOR_EMAIL="${{ github.event.head_commit.author.email || '' }}"
          COMMIT_MSG="${{ github.event.head_commit.message || 'Manual dispatch / No head_commit' }}"
          TRIGGERED_BY="${{ github.event.pusher.name || github.actor }}"
          BRANCH="${GITHUB_REF#refs/heads/}"
          REPO="${{ github.repository }}"
          SHA="${{ github.sha }}"
          SHA_SHORT="${SHA:0:7}"
          COMMIT_URL="${{ github.server_url }}/${REPO}/commit/${SHA}"
          RUN_URL="${{ github.server_url }}/${REPO}/actions/runs/${{ github.run_id }}"

          {
            echo "author_name=$AUTHOR_NAME"
            echo "author_email=$AUTHOR_EMAIL"
            echo "commit_msg=$COMMIT_MSG"
            echo "triggered_by=$TRIGGERED_BY"
            echo "branch=$BRANCH"
            echo "repo=$REPO"
            echo "sha_short=$SHA_SHORT"
            echo "commit_url=$COMMIT_URL"
            echo "run_url=$RUN_URL"
          } >> "$GITHUB_OUTPUT"

      # ====== TH√îNG B√ÅO TH·∫§T B·∫†I (BUILD) - BOT-HOOK ======
      - name: Notify Chat (build failed via bot-hook)
        if: ${{ failure() }}
        run: |
          jq -n --arg sender "${{ env.BOT_SENDER }}" \
                --arg target "${{ env.BOT_TARGET }}" \
                --arg repo "${{ steps.meta_build.outputs.repo }}" \
                --arg branch "${{ steps.meta_build.outputs.branch }}" \
                --arg sha "${{ steps.meta_build.outputs.sha_short }}" \
                --arg commit_msg "${{ steps.meta_build.outputs.commit_msg }}" \
                --arg author "${{ steps.meta_build.outputs.author_name }} <${{ steps.meta_build.outputs.author_email }}>" \
                --arg triggered_by "${{ steps.meta_build.outputs.triggered_by }}" \
                --arg run_url "${{ steps.meta_build.outputs.run_url }}" \
                --arg commit_url "${{ steps.meta_build.outputs.commit_url }}" \
                --arg push "‚ùå Build th·∫•t b·∫°i: ${{ steps.meta_build.outputs.repo }} (${{ steps.meta_build.outputs.branch }})" \
                '{
                  sender: $sender,
                  target: $target,
                  message:
                    ("‚ùå Build *TH·∫§T B·∫†I* **" + $repo + "** (GitHub Pages)\n" +
                     "‚Ä¢ Branch: " + $branch + "\n" +
                     "‚Ä¢ Commit: `" + $sha + "` ‚Äì " + $commit_msg + "\n" +
                     "‚Ä¢ T√°c gi·∫£: " + $author + "\n" +
                     "‚Ä¢ Ng∆∞·ªùi build: " + $triggered_by + "\n" +
                     "üîó Run Logs: " + $run_url + "\n" +
                     "üîó Commit: " + $commit_url),
                  push: $push
                }' > chat_build_failed.json
          
          curl -sS -X POST "${{ env.BOT_HOOK_URL }}" \
               -H "Authorization: Bearer ${{ env.BOT_HOOK_TOKEN }}" \
               -H "Content-Type: application/json" \
               --data @chat_build_failed.json

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4

      - name: Install jq (for JSON payload)
        run: sudo apt-get update && sudo apt-get install -y jq

      # ====== TH√îNG B√ÅO TH√ÄNH C√îNG (DEPLOY) - BOT-HOOK ======
      - name: Notify Chat (deploy success via bot-hook)
        if: ${{ success() }}
        run: |
          jq -n --arg sender "${{ env.BOT_SENDER }}" \
                --arg target "${{ env.BOT_TARGET }}" \
                --arg repo "${{ needs.build.outputs.repo }}" \
                --arg branch "${{ needs.build.outputs.branch }}" \
                --arg sha "${{ needs.build.outputs.sha_short }}" \
                --arg commit_msg "${{ needs.build.outputs.commit_msg }}" \
                --arg author "${{ needs.build.outputs.author_name }} <${{ needs.build.outputs.author_email }}>" \
                --arg triggered_by "${{ needs.build.outputs.triggered_by }}" \
                --arg page_url "${{ steps.deployment.outputs.page_url }}" \
                --arg run_url "${{ needs.build.outputs.run_url }}" \
                --arg commit_url "${{ needs.build.outputs.commit_url }}" \
                --arg push "üöÄ Deploy th√†nh c√¥ng: ${{ needs.build.outputs.repo }} (${{ needs.build.outputs.branch }})" \
                '{
                  sender: $sender,
                  target: $target,
                  message:
                    ("‚úÖ Deploy th√†nh c√¥ng **" + $repo + "** l√™n GitHub Pages\n" +
                     "‚Ä¢ Branch: " + $branch + "\n" +
                     "‚Ä¢ Commit: `" + $sha + "` ‚Äì " + $commit_msg + "\n" +
                     "‚Ä¢ T√°c gi·∫£: " + $author + "\n" +
                     "‚Ä¢ Ng∆∞·ªùi build: " + $triggered_by + "\n" +
                     "üåê Page URL: " + $page_url + "\n" +
                     "üîó Run Logs: " + $run_url + "\n" +
                     "üîó Commit: " + $commit_url),
                  push: $push
                }' > chat_deploy_success.json
          
          curl -sS -X POST "${{ env.BOT_HOOK_URL }}" \
               -H "Authorization: Bearer ${{ env.BOT_HOOK_TOKEN }}" \
               -H "Content-Type: application/json" \
               --data @chat_deploy_success.json

      # ====== TH√îNG B√ÅO TH·∫§T B·∫†I (DEPLOY) - BOT-HOOK ======
      - name: Notify Chat (deploy failed via bot-hook)
        if: ${{ failure() }}
        run: |
          jq -n --arg sender "${{ env.BOT_SENDER }}" \
                --arg target "${{ env.BOT_TARGET }}" \
                --arg repo "${{ needs.build.outputs.repo }}" \
                --arg branch "${{ needs.build.outputs.branch }}" \
                --arg sha "${{ needs.build.outputs.sha_short }}" \
                --arg commit_msg "${{ needs.build.outputs.commit_msg }}" \
                --arg author "${{ needs.build.outputs.author_name }} <${{ needs.build.outputs.author_email }}>" \
                --arg triggered_by "${{ needs.build.outputs.triggered_by }}" \
                --arg run_url "${{ needs.build.outputs.run_url }}" \
                --arg commit_url "${{ needs.build.outputs.commit_url }}" \
                --arg push "üî• Deploy th·∫•t b·∫°i: ${{ needs.build.outputs.repo }} (${{ needs.build.outputs.branch }})" \
                '{
                  sender: $sender,
                  target: $target,
                  message:
                    ("‚ùå Deploy *TH·∫§T B·∫†I* **" + $repo + "** (GitHub Pages)\n" +
                     "‚Ä¢ Branch: " + $branch + "\n" +
                     "‚Ä¢ Commit: `" + $sha + "` ‚Äì " + $commit_msg + "\n" +
                     "‚Ä¢ T√°c gi·∫£: " + $author + "\n" +
                     "‚Ä¢ Ng∆∞·ªùi build: " + $triggered_by + "\n" +
                     "üîó Run Logs: " + $run_url + "\n" +
                     "üîó Commit: " + $commit_url),
                  push: $push
                }' > chat_deploy_failed.json
          
          curl -sS -X POST "${{ env.BOT_HOOK_URL }}" \
               -H "Authorization: Bearer ${{ env.BOT_HOOK_TOKEN }}" \
               -H "Content-Type: application/json" \
               --data @chat_deploy_failed.json